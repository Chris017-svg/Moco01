<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shake SOS</title>
    <style>
        body{font-family:Arial,"Microsoft JhengHei",sans-serif;padding:20px;line-height:1.8}
        button,a{padding:12px 16px;font-size:16px}
        #value{margin-top:12px;font-size:18px}
        #rule{margin-top:10px;color:#555}
        #alert{display:none;margin-top:10px;color:#b00000;font-weight:700}
        #call{display:none;margin-top:16px;background:#d60000;color:#fff;text-decoration:none;display:inline-block}
    </style>
</head>
<body>

<h2>Shake SOS ç·Šæ€¥æ±‚åŠ©</h2>
<p>æŒ‰ä¸‹æŒ‰éˆ•æˆæ¬Šå¾Œé–‹å§‹åµæ¸¬ï¼Œç•¶åµæ¸¬åˆ°ä¸æ˜åŠ‡çƒˆæ™ƒå‹•æ™‚ï¼Œå°‡é¡¯ç¤ºç·Šæ€¥è¯çµ¡æŒ‰éˆ•ã€‚</p>

<button id="btn">å–å¾—æ„Ÿæ¸¬å™¨æˆæ¬Šä¸¦é–‹å§‹</button>

<div id="value">ç›®å‰æ™ƒå‹•å¼·åº¦ï¼š-</div>

<div id="rule">â€» æ™ƒå‹•å¹…åº¦é” <strong>15</strong> ä»¥ä¸Šæœƒè¢«åµæ¸¬ç‚ºä¸æ˜åŠ‡çƒˆæ™ƒå‹•</div>

<div id="alert">ğŸš¨ åµæ¸¬åˆ°ä¸æ˜åŠ‡çƒˆæ™ƒå‹•ï¼Œå¦‚æœ‰æ„å¤–è«‹å”åŠ©æ’¥æ‰“ç·Šæ€¥é€£çµ¡äºº</div>

<a id="call" href="tel:">ğŸ“ æ’¥æ‰“ç·Šæ€¥è¯çµ¡äºº</a>

<script>
    const btn = document.getElementById("btn");
    const valueEl = document.getElementById("value");
    const ruleEl  = document.getElementById("rule");
    const alertEl = document.getElementById("alert");
    const callEl  = document.getElementById("call");

    const THRESHOLD = 15; // è§¸ç™¼é–€æª»
    const NEED_HITS = 2;  // é€£çºŒå¹¾æ¬¡è¶…éé–€æª»æ‰è§¸ç™¼ï¼ˆé¿å…èª¤åˆ¤ï¼‰
    let hit = 0;
    let started = false;

    btn.addEventListener("click", async () => {
        if (started) return;

        try {
            // æ”¯æ´æ€§æª¢æŸ¥
            if (!window.DeviceMotionEvent && !window.DeviceOrientationEvent) {
                alert("æ­¤è£ç½®ä¸æ”¯æ´ Motion/Orientation æ„Ÿæ¸¬å™¨");
                return;
            }

            // ===== iOSï¼šOrientation æˆæ¬Šï¼ˆæœ‰äº›ç‰ˆæœ¬éœ€è¦ï¼‰=====
            if (typeof DeviceOrientationEvent?.requestPermission === "function") {
                const r1 = await DeviceOrientationEvent.requestPermission();
                if (r1 !== "granted") {
                    alert("æœªå…è¨±è®€å– DeviceOrientation");
                    return;
                }
            }

            // ===== iOSï¼šMotion æˆæ¬Š =====
            if (typeof DeviceMotionEvent?.requestPermission === "function") {
                const r2 = await DeviceMotionEvent.requestPermission();
                if (r2 !== "granted") {
                    alert("æœªå…è¨±è®€å– DeviceMotion");
                    return;
                }
            }

            // å•Ÿå‹•åµæ¸¬
            window.addEventListener("devicemotion", onMotion, { passive: true });

            started = true;
            btn.disabled = true;
            btn.textContent = "æ„Ÿæ¸¬å™¨å·²å•Ÿå‹•";
        } catch (err) {
            alert("éŒ¯èª¤ï¼š" + err);
        }
    });

    function onMotion(event) {
        // iOS å¸¸è¦‹ï¼šacceleration ç‚º nullï¼Œæ‰€ä»¥å„ªå…ˆç”¨å«é‡åŠ›
        const a = event.accelerationIncludingGravity || event.acceleration;
        if (!a) return;

        const x = a.x ?? 0;
        const y = a.y ?? 0;
        const z = a.z ?? 0;

        const mag = Math.sqrt(x*x + y*y + z*z);

        // é¡¯ç¤ºå³æ™‚æ™ƒå‹•å¼·åº¦
        valueEl.textContent = "ç›®å‰æ™ƒå‹•å¼·åº¦ï¼š" + mag.toFixed(2);

        // è§¸ç™¼æ¢ä»¶ï¼šé€£çºŒè¶…æ¨™
        if (mag >= THRESHOLD) {
            hit++;
            if (hit >= NEED_HITS) {
                // è§¸ç™¼å¾Œï¼šé¡¯ç¤ºè­¦ç¤ºèˆ‡æ’¥è™Ÿã€éš±è—è¦å‰‡
                alertEl.style.display = "block";
                callEl.style.display = "inline-block";
                ruleEl.style.display = "none";
            }
        } else {
            // æœªè¶…æ¨™æ™‚æ…¢æ…¢é™ hitï¼Œé™ä½èª¤åˆ¤
            hit = Math.max(0, hit - 1);
        }
    }
</script>

</body>
</html>
