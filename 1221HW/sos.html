<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å®‰å…¨ä¸€éµæ±‚åŠ©ï¼ˆPasskey ç”Ÿç‰©è¾¨è­˜ï¼‰</title>
    <style>
        body{margin:0;padding:20px;font-family:"Microsoft JhengHei",system-ui,sans-serif;background:#f4f6f8;}
        .wrap{max-width:560px;margin:auto;}
        h1{text-align:center;margin:8px 0 14px;}
        .card{background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.05);}
        button{width:100%;padding:16px;font-size:18px;font-weight:800;border:0;border-radius:12px;cursor:pointer;}
        #btnEnroll{background:#007bff;color:#fff;}
        #btnSOS{background:#dc3545;color:#fff;margin-top:10px;}
        button:disabled{opacity:.55;cursor:not-allowed;}
        #status{margin-top:10px;font-size:14px;color:#333;text-align:center;line-height:1.5;}
        .small{font-size:12px;color:#666;text-align:center;margin-top:8px;line-height:1.5;}
        video,canvas{display:none;}
    </style>
</head>
<body>
<div class="wrap">
    <h1>ğŸš¨ å®‰å…¨ä¸€éµæ±‚åŠ©</h1>

    <div class="card">
        <button id="btnEnroll">ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼šå»ºç«‹ Passkeyï¼ˆFace ID / æŒ‡ç´‹ï¼‰</button>
        <button id="btnSOS" disabled>ä¸€éµæ±‚åŠ©ï¼ˆéœ€ç”Ÿç‰©è¾¨è­˜ï¼‰</button>
        <div id="status">å°šæœªå»ºç«‹ Passkey</div>
        <div class="small">
            é‡è¦ï¼šè«‹ç”¨ Safari/Chrome é–‹å•Ÿï¼ˆLINE å…§å»ºç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ï¼‰ã€‚<br>
            Passkey åªå­˜åœ¨ä½ çš„æ‰‹æ©Ÿ/ç³»çµ±é‡‘é‘°åœˆï¼Œç¶²ç«™æ‹¿ä¸åˆ°ä½ çš„è‡‰æˆ–æŒ‡ç´‹è³‡æ–™ã€‚
        </div>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
    const btnEnroll = document.getElementById('btnEnroll');
    const btnSOS = document.getElementById('btnSOS');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    let stream = null;
    let photoFile = null;
    let lastPos = null;

    const STORE_KEY = 'sos_passkey_cred_id_b64url';

    // ---------- small utils ----------
    const b64url = {
        // ArrayBuffer -> base64url
        enc: (buf) => {
            const bytes = new Uint8Array(buf);
            let str = '';
            for (const b of bytes) str += String.fromCharCode(b);
            return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        },
        // base64url -> Uint8Array
        dec: (s) => {
            s = s.replace(/-/g,'+').replace(/_/g,'/');
            while (s.length % 4) s += '=';
            const bin = atob(s);
            const out = new Uint8Array(bin.length);
            for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
            return out;
        }
    };

    function setStatus(text){ statusEl.textContent = text; }

    function hasPasskey(){
        return !!localStorage.getItem(STORE_KEY);
    }

    function initUI(){
        if (!window.PublicKeyCredential){
            setStatus('âŒ é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´ Passkeyï¼ˆWebAuthnï¼‰');
            btnEnroll.disabled = true;
            btnSOS.disabled = true;
            return;
        }
        if (hasPasskey()){
            setStatus('âœ… å·²å»ºç«‹ Passkeyï¼Œå¯ä½¿ç”¨ä¸€éµæ±‚åŠ©');
            btnSOS.disabled = false;
        } else {
            setStatus('å°šæœªå»ºç«‹ Passkey');
            btnSOS.disabled = true;
        }
    }

    function randomBytes(n){
        const a = new Uint8Array(n);
        crypto.getRandomValues(a);
        return a;
    }

    // ---------- Passkey: Enroll (create) ----------
    async function enrollPasskey(){
        // âš ï¸ æ­£è¦åšæ³•ï¼šchallenge æ‡‰ç”±ä¼ºæœå™¨æä¾›ä¸¦é©—è­‰ã€‚
        // ä½ ç›®å‰ç´”å‰ç«¯å±•ç¤ºç”¨ï¼šåªèƒ½åšã€Œæœ¬æ©Ÿç¢ºèªã€ç”¨é€”ï¼Œä¸èƒ½ç•¶æˆçœŸæ­£é˜²å½ç™»å…¥ã€‚
        const challenge = randomBytes(32);

        // user.id éœ€è¦æ˜¯ bytes
        const userId = randomBytes(16);

        const publicKey = {
            challenge,
            rp: { name: 'SOS Demo (Front-end)', id: location.hostname },
            user: {
                id: userId,
                name: 'sos-user',
                displayName: 'SOS User'
            },
            pubKeyCredParams: [
                { type: 'public-key', alg: -7 },   // ES256
                { type: 'public-key', alg: -257 }  // RS256
            ],
            authenticatorSelection: {
                authenticatorAttachment: 'platform', // åªç”¨æ‰‹æ©Ÿå…§å»ºï¼ˆFaceID/æŒ‡ç´‹ï¼‰ï¼Œé¿å…è·³å¤–æ¥é‡‘é‘°
                userVerification: 'required',
                residentKey: 'preferred'
            },
            timeout: 60000,
            attestation: 'none'
        };

        const cred = await navigator.credentials.create({ publicKey });
        // å­˜ credential idï¼Œå¾ŒçºŒé©—è­‰æ™‚ç”¨ allowCredentials æŒ‡å®šï¼Œé¿å…è·‘å»æ‰¾ã€ŒGoogle å®‰å…¨é‡‘é‘°ã€
        const idB64u = b64url.enc(cred.rawId);
        localStorage.setItem(STORE_KEY, idB64u);
    }

    // ---------- Passkey: Verify (get) ----------
    async function verifyPasskey(){
        const idB64u = localStorage.getItem(STORE_KEY);
        if (!idB64u) throw new Error('å°šæœªå»ºç«‹ Passkey');

        const challenge = randomBytes(32);
        const allowId = b64url.dec(idB64u);

        const publicKey = {
            challenge,
            timeout: 60000,
            userVerification: 'required',
            allowCredentials: [
                { type: 'public-key', id: allowId }
            ]
        };

        await navigator.credentials.get({ publicKey });
    }

    // ---------- Camera / Photo ----------
    async function startCamera(){
        if (!stream){
            stream = await navigator.mediaDevices.getUserMedia({ video:true });
            video.srcObject = stream;
        }
    }

    function stopAll(){
        if (stream){
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
    }

    function takePhoto(){
        const w = video.videoWidth || 1280;
        const h = video.videoHeight || 720;
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(video, 0, 0, w, h);

        return new Promise((resolve, reject) => {
            canvas.toBlob(blob => {
                if (!blob) return reject(new Error('æ‹ç…§å¤±æ•—'));
                photoFile = new File([blob], 'sos.jpg', { type:'image/jpeg' });
                resolve();
            }, 'image/jpeg', 0.92);
        });
    }

    // ---------- Location / Message ----------
    function getLocation(){
        return new Promise(resolve => {
            if (!navigator.geolocation) return resolve(null);
            navigator.geolocation.getCurrentPosition(
                pos => { lastPos = pos.coords; resolve(lastPos); },
                () => resolve(null),
                { enableHighAccuracy:true, timeout:8000, maximumAge:30000 }
            );
        });
    }

    function buildMessage(){
        const t = new Date().toLocaleString();
        let msg = `ã€ç·Šæ€¥æ±‚æ•‘ã€‘\næ™‚é–“ï¼š${t}\n`;

        if (lastPos){
            msg += `åœ°åœ–ï¼šhttps://www.google.com/maps?q=${lastPos.latitude},${lastPos.longitude}\n`;
            msg += `å®šä½èª¤å·®ï¼šç´„ ${Math.round(lastPos.accuracy)} å…¬å°º\n`;
        } else {
            msg += `ä½ç½®ï¼šæœªå–å¾—ï¼ˆå¯èƒ½æœªå…è¨±å®šä½ï¼‰\n`;
        }
        msg += `\næˆ‘éœ€è¦å”åŠ©ï¼Œè«‹ç›¡å¿«è¯çµ¡æˆ‘ã€‚`;
        return msg;
    }

    async function shareSOS(text){
        if (!navigator.share){
            alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´åˆ†äº«åŠŸèƒ½ï¼Œå¯æ”¹ç”¨è¤‡è£½è²¼åˆ° LINEã€‚');
            return;
        }

        // ç›¡é‡å¸¶ç…§ç‰‡åˆ†äº«ï¼›è‹¥è£ç½®ä¸æ”¯æ´ filesï¼Œä»å¯åˆ†äº«æ–‡å­—
        if (photoFile && navigator.canShare && navigator.canShare({ files:[photoFile] })){
            await navigator.share({ title:'ç·Šæ€¥æ±‚æ•‘', text, files:[photoFile] });
        } else {
            await navigator.share({ title:'ç·Šæ€¥æ±‚æ•‘', text });
            if (photoFile) alert('æ­¤è£ç½®/ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ã€Œå¸¶ç…§ç‰‡åˆ†äº«ã€ï¼Œå·²å…ˆåˆ†äº«æ–‡å­—ã€‚');
        }
    }

    // ---------- UI events ----------
    btnEnroll.addEventListener('click', async () => {
        btnEnroll.disabled = true;
        try{
            setStatus('ğŸ” å»ºç«‹ Passkey ä¸­â€¦');
            await enrollPasskey();
            setStatus('âœ… å»ºç«‹å®Œæˆï¼ä¹‹å¾Œå¯ç›´æ¥ä¸€éµæ±‚åŠ©');
            btnSOS.disabled = false;
        } catch (e){
            console.log(e);
            setStatus('âŒ å»ºç«‹å¤±æ•—/å·²å–æ¶ˆï¼ˆè«‹ç”¨ Safari/Chromeï¼Œé¿å… LINE å…§å»ºï¼‰');
        } finally {
            btnEnroll.disabled = false;
        }
    });

    btnSOS.addEventListener('click', async () => {
        btnSOS.disabled = true;
        try{
            setStatus('ğŸ” ç”Ÿç‰©è¾¨è­˜é©—è­‰ä¸­â€¦');
            await verifyPasskey(); // é€™è£¡æ‰æœƒè·³ FaceID/æŒ‡ç´‹ï¼ˆå‰æï¼šå·² enrollï¼‰

            setStatus('ğŸ“· å•Ÿç”¨ç›¸æ©Ÿâ€¦');
            await startCamera();

            setStatus('ğŸ“ å–å¾—å®šä½â€¦');
            await getLocation();

            setStatus('ğŸ“¸ æ‹ç…§ä¸­â€¦');
            await takePhoto();

            const text = buildMessage();
            setStatus('ğŸ“¤ é–‹å•Ÿåˆ†äº«é¢æ¿â€¦');
            await shareSOS(text);

            setStatus('âœ… æ±‚åŠ©æµç¨‹å®Œæˆ');
        } catch (e){
            console.log(e);
            setStatus('âŒ å·²å–æ¶ˆæˆ–å¤±æ•—');
        } finally {
            btnSOS.disabled = false;
            stopAll(); // ç”¨å®Œå°±é—œç›¸æ©Ÿï¼ˆæ›´å®‰å…¨ï¼‰
        }
    });

    // å®‰å…¨ï¼šé›¢é–‹é é¢ä¹Ÿé—œæ‰ç›¸æ©Ÿ
    window.addEventListener('pagehide', stopAll);
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) stopAll();
    });

    initUI();
</script>
</body>
</html>
