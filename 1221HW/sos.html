<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å®‰å…¨ä¸€éµæ±‚åŠ©ï¼ˆç”Ÿç‰©è¾¨è­˜ï¼‰</title>

    <style>
        body{
            margin:0; padding:20px;
            font-family:"Microsoft JhengHei", system-ui, sans-serif;
            background:#f4f6f8;
        }
        .wrap{max-width:520px;margin:auto;}
        h1{text-align:center;}
        button{
            width:100%;
            padding:18px;
            font-size:22px;
            font-weight:bold;
            border:none;
            border-radius:14px;
            cursor:pointer;
        }
        #sosBtn{background:#dc3545;color:#fff;}
        #status{margin-top:14px;font-size:14px;color:#333;text-align:center;}
        video{display:none;}
        canvas{display:none;}
        .small{font-size:12px;color:#666;text-align:center;margin-top:8px;}
    </style>
</head>

<body>
<div class="wrap">
    <h1>ğŸš¨ ç·Šæ€¥æ±‚åŠ©</h1>

    <button id="sosBtn">ä¸€éµæ±‚åŠ©</button>

    <div id="status">å¾…å‘½ä¸­</div>
    <div class="small">éœ€é€šéç”Ÿç‰©è¾¨è­˜ï¼Œè³‡æ–™ä¸æœƒè‡ªå‹•å‚³é€</div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
</div>

<script>
    const sosBtn = document.getElementById('sosBtn');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');

    let stream = null;
    let photoFile = null;
    let lastPos = null;

    /* ---------- ç”Ÿç‰©è¾¨è­˜ï¼ˆWebAuthn / Passkeyï¼‰---------- */
    async function biometricAuth(){
        if (!window.PublicKeyCredential) {
            throw new Error('æ­¤è£ç½®ä¸æ”¯æ´ç”Ÿç‰©è¾¨è­˜');
        }
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        await navigator.credentials.get({
            publicKey:{
                challenge,
                userVerification:'required',
                timeout:60000
            }
        });
    }

    /* ---------- ç›¸æ©Ÿ ---------- */
    async function startCamera(){
        if (!stream){
            stream = await navigator.mediaDevices.getUserMedia({video:true});
            video.srcObject = stream;
        }
    }

    function takePhoto(){
        const w = video.videoWidth || 1280;
        const h = video.videoHeight || 720;
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(video,0,0,w,h);

        return new Promise(res=>{
            canvas.toBlob(blob=>{
                photoFile = new File([blob],'sos.jpg',{type:'image/jpeg'});
                res();
            },'image/jpeg',0.9);
        });
    }

    /* ---------- å®šä½ ---------- */
    function getLocation(){
        return new Promise(resolve=>{
            if (!navigator.geolocation) return resolve(null);
            navigator.geolocation.getCurrentPosition(pos=>{
                lastPos = pos.coords;
                resolve(lastPos);
            },()=>resolve(null),{
                enableHighAccuracy:true,
                timeout:8000
            });
        });
    }

    /* ---------- è¨Šæ¯ ---------- */
    function buildMessage(){
        let msg = `ã€ç·Šæ€¥æ±‚æ•‘ã€‘\næ™‚é–“ï¼š${new Date().toLocaleString()}\n`;
        if (lastPos){
            msg += `ä½ç½®ï¼šhttps://www.google.com/maps?q=${lastPos.latitude},${lastPos.longitude}\n`;
            msg += `èª¤å·®ï¼šç´„ ${Math.round(lastPos.accuracy)} å…¬å°º\n`;
        } else {
            msg += `ä½ç½®ï¼šæœªå–å¾—\n`;
        }
        msg += `\næˆ‘éœ€è¦å”åŠ©ï¼Œè«‹ç›¡å¿«è¯çµ¡æˆ‘ã€‚`;
        return msg;
    }

    /* ---------- ä¸»æµç¨‹ ---------- */
    sosBtn.onclick = async ()=>{
        try{
            sosBtn.disabled = true;
            statusEl.textContent = 'ğŸ” ç”Ÿç‰©è¾¨è­˜ä¸­â€¦';

            // â‘  ç”Ÿç‰©è¾¨è­˜
            await biometricAuth();

            statusEl.textContent = 'ğŸ“· å•Ÿç”¨ç›¸æ©Ÿâ€¦';
            await startCamera();

            statusEl.textContent = 'ğŸ“ å–å¾—å®šä½â€¦';
            await getLocation();

            statusEl.textContent = 'ğŸ“¸ æ‹ç…§ä¸­â€¦';
            await takePhoto();

            const text = buildMessage();

            statusEl.textContent = 'ğŸ“¤ æº–å‚™åˆ†äº«â€¦';

            if (navigator.share && navigator.canShare({files:[photoFile]})){
                await navigator.share({
                    title:'ç·Šæ€¥æ±‚åŠ©',
                    text,
                    files:[photoFile]
                });
            } else {
                await navigator.share({title:'ç·Šæ€¥æ±‚åŠ©', text});
            }

            statusEl.textContent = 'âœ… æ±‚åŠ©æµç¨‹å®Œæˆ';

        }catch(e){
            statusEl.textContent = 'âŒ å·²å–æ¶ˆæˆ–å¤±æ•—';
        }finally{
            sosBtn.disabled = false;
        }
    };

    /* ---------- é›¢é–‹é é¢è‡ªå‹•é—œ ---------- */
    function stopAll(){
        if (stream){
            stream.getTracks().forEach(t=>t.stop());
            stream=null;
        }
    }
    window.addEventListener('pagehide',stopAll);
    document.addEventListener('visibilitychange',()=>{
        if(document.hidden) stopAll();
    });
</script>
</body>
</html>
